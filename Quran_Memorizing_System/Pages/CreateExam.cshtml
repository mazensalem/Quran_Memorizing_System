@page
@model Quran_Memorizing_System.Pages.CreateExamModel
@{
}

@section Styles {
    <style>
        .question-card {
            border-left: 4px solid #0d6efd;
        }

        .choice-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .question-number {
            background-color: #0d6efd;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
    </style>

}

<div class="container mt-4">
    <h1 class="mb-4">Create New Exam</h1>

    <form method="post" id="examForm" asp-route-type="finished">
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title mb-3">Exam Details</h5>
                
                <div class="mb-3">
                    <label asp-for="ExamTitle" class="form-label">Exam Title</label>
                    <input asp-for="ExamTitle" class="form-control" />
                    <span asp-validation-for="ExamTitle" class="text-danger"></span>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                    <label asp-for="StartTime" class="form-label">Start Time</label>
                    <input asp-for="StartTime" type="date" class="form-control" />
                        <span asp-validation-for="StartTime" class="text-danger"></span>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label asp-for="EndTime" class="form-label">End Time</label>
                        <input asp-for="EndTime" type="date" class="form-control" />
                        <span asp-validation-for="EndTime" class="text-danger"></span>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="ExamDuration" class="form-label">Duration (minutes)</label>
                        <input asp-for="ExamDuration" type="number" class="form-control" min="1" max="300" />
                        <span asp-validation-for="ExamDuration" class="text-danger"></span>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label asp-for="CircleID" class="form-label">Circle (Optional)</label>
                        <select asp-for="CircleID" class="form-select">
                            <option value="">-- Select a Circle --</option>
                            @foreach (var circle in Model.UserCircles)
                            {
                                <option value="@circle.ID">@circle.Name</option>
                            }
                        </select>
                        <span asp-validation-for="CircleID" class="text-danger"></span>
                    </div>
                </div>

                <div class="mb-3 form-check">
                    <input asp-for="PublicAvailability" type="checkbox" class="form-check-input" id="publicAvailability" />
                    <label class="form-check-label" for="publicAvailability">
                        Make this exam publicly available
                    </label>
                </div>
            </div>
        </div>

        <div id="questionsContainer">
            <!-- Questions will be added here dynamically -->
        </div>

        <div class="mb-4">
            <button type="button" class="btn btn-primary me-2" onclick="addQuestion('mcq')">
                <i class="bi bi-plus-circle"></i> Add MCQ Question
            </button>
            <button type="button" class="btn btn-secondary" onclick="addQuestion('text')">
                <i class="bi bi-plus-circle"></i> Add Open Text Question
            </button>
        </div>

        <div class="mb-4">
            <button asp-page-handler="Save" type="submit" class="btn btn-success btn-lg" >
                <i class="bi bi-save"></i> Save Exam
            </button>
            <button asp-page-handler="Draft" type="submit" class="btn btn-success btn-lg">
                <i class="bi bi-save"></i> Save Draft
            </button>
            <a asp-page="/Index" class="btn btn-outline-secondary btn-lg ms-2">Cancel</a>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        let questionCounter = 0;

        function addQuestion(type) {
            questionCounter++;
            const container = document.getElementById('questionsContainer');
            const questionDiv = document.createElement('div');
            questionDiv.className = 'card mb-3 question-card';
            questionDiv.id = `question-${questionCounter}`;

            let questionHtml = `
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0">
                            <span class="question-number">${questionCounter}</span>
                            <span class="ms-2">${type === 'mcq' ? 'Multiple Choice Question' : 'Open Text Question'}</span>
                        </h5>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeQuestion(${questionCounter})">
                            <i class="bi bi-trash"></i> Remove
                        </button>
                    </div>

                    <input type="hidden" name="Questions[${questionCounter - 1}].Type" value="${type}" />

                    <div class="mb-3">
                        <label class="form-label">Question Title</label>
                        <input type="text" name="Questions[${questionCounter - 1}].Title" class="form-control" required />
                    </div>
            `;

            if (type === 'mcq') {
                questionHtml += `
                    <div class="mb-3">
                        <label class="form-label">Choices</label>
                        <div id="choices-${questionCounter}">
                            ${createChoiceHtml(questionCounter, 0)}
                            ${createChoiceHtml(questionCounter, 1)}
                            ${createChoiceHtml(questionCounter, 2)}
                            ${createChoiceHtml(questionCounter, 3)}
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addChoice(${questionCounter})">
                            <i class="bi bi-plus"></i> Add Choice
                        </button>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Correct Answer</label>
                        <select class="form-select correct-answer-select" data-question-index="${questionCounter - 1}">
                            <option value="" data-choice-index="0">Choice 1</option>
                            <option value="" data-choice-index="1">Choice 2</option>
                            <option value="" data-choice-index="2">Choice 3</option>
                            <option value="" data-choice-index="3">Choice 4</option>
                        </select>
                    </div>
                `;
            } else {
            }

            questionHtml += `</div>`;
            questionDiv.innerHTML = questionHtml;
            container.appendChild(questionDiv);
        }

        function createChoiceHtml(questionNum, choiceNum) {
            return `
                <div class="choice-item" id="choice-${questionNum}-${choiceNum}">
                    <span class="badge bg-secondary">${String.fromCharCode(65 + choiceNum)}</span>
                    <input type="text" name="Questions[${questionNum - 1}].Choices[${choiceNum}].Text" class="form-control" required />
                    ${choiceNum > 1 ? `<button type="button" class="btn btn-sm btn-outline-danger" onclick="removeChoice(${questionNum}, ${choiceNum})"><i class="bi bi-x"></i></button>` : ''}
                </div>
            `;
        }

        function addChoice(questionNum) {
            const choicesContainer = document.getElementById(`choices-${questionNum}`);
            const choiceCount = choicesContainer.children.length;
            const choiceDiv = document.createElement('div');
            choiceDiv.className = 'choice-item';
            choiceDiv.id = `choice-${questionNum}-${choiceCount}`;
            choiceDiv.innerHTML = `
                <span class="badge bg-secondary">${String.fromCharCode(65 + choiceCount)}</span>
                <input type="text" name="Questions[${questionNum - 1}].Choices[${choiceCount}].Text" class="form-control" required />
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeChoice(${questionNum}, ${choiceCount})"><i class="bi bi-x"></i></button>
            `;
            choicesContainer.appendChild(choiceDiv);

            // Update correct answer dropdown
            const select = document.querySelector(`select[name="Questions[${questionNum - 1}].CorrectAnswerText"]`);
            const option = document.createElement('option');
            option.value = '';
            option.setAttribute('data-choice-index', choiceCount);
            option.textContent = `Choice ${choiceCount + 1}`;
            select.appendChild(option);
        }

        function removeChoice(questionNum, choiceNum) {
            const choiceDiv = document.getElementById(`choice-${questionNum}-${choiceNum}`);
            if (choiceDiv) {
                choiceDiv.remove();
            }
        }

        function removeQuestion(questionNum) {
            const questionDiv = document.getElementById(`question-${questionNum}`);
            if (questionDiv) {
                questionDiv.remove();
            }
        }

        // Handle form submission to populate correct answer text
        document.getElementById('examForm').addEventListener('submit', function(e) {
            // For each correct answer dropdown, create a hidden input with the actual choice text
            const correctAnswerSelects = document.querySelectorAll('.correct-answer-select');
            
            correctAnswerSelects.forEach(select => {
                const selectedOption = select.options[select.selectedIndex];
                const choiceIndex = selectedOption.getAttribute('data-choice-index');
                const questionIndex = select.getAttribute('data-question-index');
                
                // Get the actual choice text from the input field
                const choiceInput = document.querySelector(`input[name="Questions[${questionIndex}].Choices[${choiceIndex}].Text"]`);
                
                if (choiceInput && choiceInput.value) {
                    // Create or update a hidden input with the correct answer text
                    let hiddenInput = document.querySelector(`input[name="Questions[${questionIndex}].CorrectAnswerText"]`);
                    if (!hiddenInput) {
                        hiddenInput = document.createElement('input');
                        hiddenInput.type = 'hidden';
                        hiddenInput.name = `Questions[${questionIndex}].CorrectAnswerText`;
                        select.parentElement.appendChild(hiddenInput);
                    }
                    hiddenInput.value = choiceInput.value;
                    
                    console.log(`Question ${questionIndex}: Correct answer set to "${choiceInput.value}"`);
                } else {
                    // If choice input not found or empty, prevent submission
                    e.preventDefault();
                    alert('Please fill in all choices before selecting a correct answer.');
                    return false;
                }
            });
        });

        // Add Bootstrap Icons if not already included
        if (!document.querySelector('link[href*="bootstrap-icons"]')) {
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css';
            document.head.appendChild(link);
        }
    </script>
}