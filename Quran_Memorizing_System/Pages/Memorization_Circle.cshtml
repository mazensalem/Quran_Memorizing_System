@page
@model Quran_Memorizing_System.Pages.MemorizationCircleModel
@{
    @using System.Data
}

<div class="container mt-4">
    @if (TempData["SuccessMessage"] != null)
    {
        <div>
            @TempData["SuccessMessage"]
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div>
            @TempData["ErrorMessage"]
        </div>
    }
    <div class="row">

        <!-- LEFT SIDE -->
        <div class="col-md-8">

            <!-- Share box -->
            <div class="d-flex align-items-center border rounded-4 p-3 mb-4">
                <input type="text" class="form-control me-3" placeholder="Share Some Information" />
                <button class="btn btn-dark px-4">Share</button>
            </div>

            <!-- POSTS -->
            @foreach (DataRow p in Model.Posts.Rows)
            {
                <div class="p-4 mb-4 bg-light rounded-4" style="background-color:#e8f0fa !important;">
                    <div class="d-flex align-items-center mb-2">
                        <div class="rounded-circle bg-secondary me-2" style="width:40px; height:40px;"></div>
                        <strong>@p["Sh_Email"]</strong>
                    </div>
                    <p class="mb-0">@p["Description"]</p>
                </div>
            }

        </div>

        <!-- RIGHT SIDE -->
        <div class="col-md-4">
            @if (Model.role == "Sheikh")
            {                
                <!-- MEMBERS -->
                <h5 class="fw-bold mb-2">MEMBERS</h5>
                

                <!-- Add members-->
                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#AddMemberModal">ADD</button>


                <!-- Confirmation Modal -->
                <div class="modal fade" id="AddMemberModal" tabindex="-1" aria-labelledby="AddMemberModallable" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <form method="post" asp-page-handler="Addmember">
                                Enter the email of the person you want to add
                                <input asp-for="addmemberemail" />
                                <input asp-for="Name" type="hidden" />
                                <button type="submit">Add</button>
                                <span asp-validation-for="addmemberemail"></span>
                            </form>
                        </div>
                    </div>
                </div>
                
                
                
                <hr class="mt-0"/>

                @foreach (DataRow m in Model.Members.Rows)
                {
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <span> @m["Participant_Email"] </span>

                        @if (false)
                        {
                            <div>
                                <button class="btn btn-outline-danger btn-sm">Deny</button>
                                <button class="btn btn-outline-success btn-sm">Accept</button>
                            </div>
                        }
                        else
                        {
                            <form method="post" asp-page-handler="Removeuser">
                                <input asp-for="Name" type="hidden" />
                                <input name="email" value="@m["Participant_Email"]" type="hidden" />
                                <button class="btn btn-outline-dark btn-sm" type="submit">Kick out</button>
                            </form>
                        }
                    </div>
                }
            }
        </div>

    </div>
</div>

@if (Model.role == "Sheikh")
{
    <!-- Circle settings -->
    <div class="mb-3">
        <h5 class="fw-bold">Circle Settings</h5>

        <!-- Edit Circle -->
        <form method="post" asp-page-handler="UpdateCircle" class="mb-2">
            <div class="mb-2">
                <label class="form-label">Circle Name</label>
                <input asp-for="NewCircleName" class="form-control" value="@Model.Name" />
            </div>
            <div class="form-check mb-2">
                <input asp-for="NewPublicAvailable" class="form-check-input" id="publicCheck" />
                <label class="form-check-label" for="publicCheck">Public Available</label>
            </div>
            <input asp-for="Name" type="hidden" />
            <button type="submit" class="btn btn-primary btn-sm">Update Circle</button>
        </form>

        <!-- Delete Circle -->
        <form method="post" asp-page-handler="DeleteCircle"
              onsubmit="return confirm('Are you sure you want to delete this circle?');">
            <input asp-for="Name" type="hidden" />
            <button type="submit" class="btn btn-danger btn-sm">Delete Circle</button>
        </form>
    </div>

    <!--Shouldn't this be at the beginning of the page-->
    <!--  make announcement -->
    <div class="d-flex align-items-center border rounded-4 p-3 mb-4">
        <form method="post" asp-page-handler="AddAnnouncement" class="d-flex w-100">
            <input asp-for="NewAnnouncement"
                   class="form-control me-3"
                   placeholder="Share Some Information" />
            <input asp-for="Name" type="hidden" />
            <button type="submit" class="btn btn-dark px-4">Share</button>
        </form>
    </div>
    
    <!--  edit or delete announcement -->
    @for (int i=0;i<Model.Posts.Rows.Count;i++)
    {
        <div class="p-4 mb-4 bg-light rounded-4" style="background-color:#e8f0fa !important;">
            <div class="d-flex align-items-center mb-2">
                <div class="rounded-circle bg-secondary me-2" style="width:40px; height:40px;"></div>
                <strong>@Model.Posts.Rows[i]["Sh_Email"]</strong>
            </div>

            <!--I have no idea why but getting the column by name didn't work and getting it by index did-->
            <!--Take care this would allow any Sheikhs to have access even if they aren't admins in this spacific circle-->
            @if (Model.role == "Sheikh")
            {
                <!--  Edit -->
                <!-- This would allow Sheikhs to edit announcments even if they weren't the one's who made them -->
                <form method="post" asp-page-handler="EditAnnouncement" class="mb-2">
                    <input type="hidden" asp-for="EditAnnouncementId" value="@Model.Posts.Rows[i][4]" />
                    
                    <!-- The value in between the tages gets overriden by the asp-for -->
                    <!--This is not a solution since the data is not bind to the backend-->
                    <textarea asp-for="@Model.Posts.Rows[i][0]" class="form-control mb-2"></textarea>
                    <input asp-for="Name" type="hidden" />
                    <button type="submit" class="btn btn-primary btn-sm">Save</button>
                </form>

                <!--  Delete -->
                <form method="post" asp-page-handler="DeleteAnnouncement"
                      onsubmit="return confirm('Delete this announcement?');">
                    <input type="hidden" name="id" value="@Model.Posts.Rows[i][4]" />
                    <input asp-for="Name" type="hidden" />
                    <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                </form>
            }
            else
            {
                <p class="mb-0">@Model.Posts.Rows[i][0]</p>
            }

        </div>
    }

}



<!--Shouldn't this be with the other view of the posts-->
@foreach (DataRow p in Model.Posts.Rows)
{
    <!--Same thing with the column name -->
    var annId = (int)p[4];

    <div class="p-4 mb-4 bg-light rounded-4" style="background-color:#e8f0fa !important;">
        <div class="d-flex align-items-center mb-2">
            <div class="rounded-circle bg-secondary me-2" style="width:40px; height:40px;"></div>
            <strong>@p["Sh_Email"]</strong>
        </div>
        <p class="mb-2">@p["Description"]</p>

        <!-- comments  -->
        <div class="ms-4">
            @* Add comment *@
            @if (Model.role == "Participant")
            {
                <form method="post" asp-page-handler="AddComment" class="d-flex mb-2">
                    <input type="hidden" asp-for="NewCommentAnnouncementId" value="@annId" />
                    <input asp-for="NewCommentText" class="form-control me-2" placeholder="Write a comment..." />
                    <input asp-for="Name" type="hidden" />
                    <button type="submit" class="btn btn-outline-primary btn-sm">Comment</button>
                </form>
            }

            @* Get comments for this announcement *@
            @{
                DataTable comments = null;
                if (Model.CommentsByAnnouncement != null &&
                Model.CommentsByAnnouncement.ContainsKey(annId))
                {
                    comments = Model.CommentsByAnnouncement[annId];
                }
            }

            @* Show comments *@
            @if (comments != null)
            {
                @foreach (DataRow c in comments.Rows)
                {
                    <div class="mb-2">
                        <small class="text-muted">@c["Participant_Email"]</small><br />

                        @if (Model.role == "Participant"
                                    && Convert.ToString(c["Participant_Email"]) == HttpContext.Session.GetString("email"))
                        {
                            <!-- Edit comment -->
                            <form method="post" asp-page-handler="EditComment" class="d-flex mb-1">
                                <!--Again some mismatches-->
                                <input type="hidden" asp-for="EditCommentId" value="@c["announcement_ID"]" />
                                <input asp-for="EditCommentText" class="form-control me-2" value="@c["text"]" />
                                <input asp-for="Name" type="hidden" />
                                <button type="submit" class="btn btn-primary btn-sm">Save</button>
                            </form>

                            <!-- Delete comment -->
                            <form method="post" asp-page-handler="DeleteComment"
                                  onsubmit="return confirm('Delete this comment?');">
                                <input type="hidden" name="id" value="@c["announcement_ID"]" />
                                <input asp-for="Name" type="hidden" />
                                <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                            </form>
                        }
                        else
                        {
                            <!--Name Mismatch-->
                            <span>@c["text"]</span>
                        }
                    </div>
                }
            }
        </div>
    </div>
}
